@model IEnumerable<DormitoryManagement.Models.Class>

@using PagedList
@using PagedList.Mvc
@{

    ViewBag.Title = "Index";
    Layout = "~/Views/LayoutPage.cshtml";
}
<link href="~/Content/MyClass.css" rel="stylesheet" />
<link href="~/dist/css/jquery.page.css" rel="stylesheet" />
<script src="~/dist/js/jquery.page.js"></script>
<div class="page-breadcrumb">
    <div class="row">
        <div class="col-5 align-self-center">
            <h4 class="page-title">班级管理</h4>
        </div>
        <div class="col-7 align-self-center">
            <div class="d-flex align-items-center justify-content-end">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item">
                            <a href="#">首页</a>
                        </li>
                        <li class="breadcrumb-item active" aria-current="page">班级管理</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>
    <div class="row">
        <button class="btn btn-sm" title="添加" data-toggle="modal" data-target="#AddClass" id="Addbtn">
            <img src="~/Image/plus.svg" />
        </button>

    </div>
</div>

<table id="tab" border="1" class="table table-condensed table-bordered table-striped"></table>
@*分页*@
<div id="Fy">
    <div class="pagination " id="page"></div>
</div>
@*@Html.ShowPageNavigate((int)ViewData["pageIndex"], (int)ViewData["pageSize"],(int)ViewData["total"])*@
@*添加班级模态框*@
<div class="modal fade" id="AddClass" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="myModalLabel">
                    添加班级
                </h4>
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                    &times;
                </button>
            </div>
            <div class="modal-body">
                班级名称：
                <input type="text" id="AddClassName" />
                <span style="color:#aa2323;font-size:1.2em" id="alert"></span>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">
                    关闭
                </button>
                <button type="button" class="btn btn-primary " id="OK">
                    提交更改
                </button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal -->
</div>
<!-- 添加学生模态框 -->
<div class="modal fade" id="AddStudent">
    <div class="modal-dialog">
        <div class="modal-content" style="width:650px;">
            <!-- 模态框头部 -->
            <div class="modal-header">
                <h4 class="modal-title" id="StudentManagementtitle"></h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>

            <!-- 模态框主体 -->
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6 AddStuLeft">
                        <div class="row title">已有学生</div>
                        <div class="row"><table id="tabl" class="table table-condensed table-bordered table-striped"></table></div>
                        <div class="row"><button class="Mobile_bedroom right btn btn-default" id="outbtn">移出该班级</button></div>
                    </div>
                    @*添加学生*@
                    <div class="col-md-6 AddStuRight">
                        <div class="row title">添加学生</div>
                        <div class="row" style="margin-left:1px">
                            <label for="class">班级:</label>
                            <select id="class" style="border-radius:5px;"></select>
                        </div>
                        <div class="row" style="margin-top:4px;margin-left:1px">
                            <label>姓名:</label>
                            <div>
                                <input type="text" id="Stu_Name" class="searchinput left" />
                                <span class="searchbtn" id="Searchbtn"><img src="~/Image/search.svg" /></span>
                            </div>
                        </div>
                        <div class="row"><span style="margin-left:25%; color:#aa2323;font-size:0.8em;height:10px" id="stu_alert"></span></div>
                        <div class="StuContent row pre-scrollable">
                            <table id="Stutable" border="1" class="table table-condensed table-bordered table-striped"></table>
                        </div>
                        <div class="row"><button class="Mobile_bedroom right btn btn-default" id="Movebtn">移动至该班级</button></div>
                    </div>
                </div>
            </div>

            <!-- 模态框底部 -->
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal" id="AddstuEsc">关闭</button>
            </div>

        </div>
    </div>
</div>
<!-- 修改班级信息模态框 -->
<div class="modal fade" id="UpdateClassInfo">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <!-- 模态框头部 -->
            <div class="modal-header">
                <h4 class="modal-title">修改学生信息</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>

            <!-- 模态框主体 -->
            <div class="modal-body">
                <div class="row">
                    <label>班级编号：</label><input type="text" id="ClassName" />
                </div>
                <div class="row">
                    <span style="color:red;height:10px;" id="UpdateClassInfoalert"></span>
                </div>
            </div>

            <!-- 模态框底部 -->
            <div class="modal-footer">
                <button type="button" class="btn btn-primary " id="UpdateClassInfoOK">
                    提交
                </button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal" id="Esc">
                    关闭
                </button>
            </div>

        </div>
    </div>
</div>
<script>
         var State = "";//用于判断班级名是否可用状态
        var pagenumber = 1;//起始页码
        var MAXpagenumber =0;//最大页数。
        var ALLdata = "";//用于保存后台返回的数据
        var ClassId = 0;//用于保存班级下拉框的值
    var oldName = ""//用于保存班级以前的编号（修改用）
    var pd//用来判断请求时否执行完
    var Le;//用于判断联想词异步是否执行完
    //实时查询学生信息
    var cpLock = false;
    $("#Stu_Name").on('compositionstart', function () {
        // 输入汉语拼音时锁住搜索框，不进行搜索，或者从汉语拼音转到字母时也可触发
        cpLock = true;
    });
    $("#Stu_Name").on('compositionend', function () {
        // 结束汉语拼音输入并生成汉字时，解锁搜索框，进行搜索
        cpLock = false;
        FandStuByClassorName();
    });
    //点击搜索按钮的时候进行搜索
    $("#Searchbtn").click(function () {
        FandStuByClassorName();
    });

    //根据学生姓名或者班级查询学生
    function FandStuByClassorName() {
        var keyword = $("#Stu_Name").val();
        var xl = $("#class").val();
        if (xl != null) {
            var Classid = $("#class").val();
        } else {
            Classid = 0;
        }

        var data = {
            Classid: Classid,
            StudentName: keyword
        }
        $.post("/Class/SelectStuByNameorClass", data, function (data) {
            data = JSON.parse(data);//把json字符串转换为json对象
            var qs = "空"//用于存放学生寝室编号
            var bj = "空"//用于存放班级编号
            var item = "<tr><td>选择</td><td>姓名</td><td>寝室</td><td>班级</td></tr>"
            //遍历集合
            $.each(data, function (index, value) {
                if (value.srCheckinTime != null) {
                    qs = value.Number;
                }
                if (value.crCheckinTime != null) {
                    bj = value.CLassName

                }
                item += "<tr>";
                item += "<td><label><input Id='ddx' type='checkbox' name='IntoStu' class='rediobtn' value=" + value.Id + "></label></td>";
                item += "<td>" + value.Name + "</td>";
                item += "<td>" + qs + "</td>";
                item += "<td>" + bj + "</td>";
                item += "</tr>";
            });
            $("#Stutable").html(item);
        });
    }
    //查询班级已有学生
    function SelectStu(id) {
        var data = {
            ClassId: id
        }
        $.get("/Class/FindStu", data, function (data) {
            var item = "";
            item = "<tr><td>选择</td><td>学生姓名</td><td>联系方式</td></tr>";
            if (data.length < 1) {
                $("#outbtn").css("display", "none")
                item = "<tr><td>该班级暂无学生</td></tr>"
            } else {
                $("#outbtn").css("display", "block")
            }
            //遍历集合
            $.each(data, function (index, value) {
                item += "<tr>";
                item += "<td><label><input Id='Studx' type='checkbox' name='OutStu' class='rediobtn' value=" + value.Id + "></label></td>";
                item += "<td>" + value.Name + "</td>";
                item += "<td>" + value.Contact + "</td>";
                item += "</tr>";
            });
            $("#tabl").html(item);
        });

    }
    
    // 搜索
    function Search(Conditions) {
        var data = {
            page: pagenumber,
            Value: Conditions
        };
        pd = $.post("/Class/FindAll", data, function (data) {
            MAXpagenumber = data.pg;
            data = JSON.parse(data.ret);//把json字符串转换为json对象
                ALLdata = data;
                var item = "<tr><td>选择</td><td>@Html.DisplayNameFor(model => model.ClassName)</td><td>班级已有人数</td><td colspan='4'>操作</td></tr>";
                var state = "";//用于判断当前班级是否启用
                //遍历集合
                $.each(data, function (index, value) {
                    if (value.State == 0) {
                        state = "停用"
                        se = "NoSelected";
                    } else {
                        se ="Selected"
                        state = "启用"
                    }
                    if (value.Number != 0) {
                        asx = "Selected";//如果班级还有学生就不能停用
                    } else {
                        asx = "NoSelected";
                    }
                    item += "<tr>";
                    item += "<td><label><input Id='dx' type='checkbox' name='Class' class='rediobtn' value="+value.Id+"></label></td>";
                    item += "<td>" + value.ClassName + "</td>";
                    item += "<td>" + value.Number + "</td>";
                    item += "<td><a href='#'onclick='update(" + index + ")' class="+asx+" >" + state + "</a></td>";
                    item += "<td><a href='#' class=" + se + " onclick='AddStudent(" + index + ")' class='Selected'data-toggle='modal' data-target='#AddStudent'>学生管理</a></td>";
                    item += "<td><a href='#' class=" + se + " onclick='UpdateClassInfo(" + index + ")' class='Selected'data-toggle='modal' data-target='#UpdateClassInfo'>修改班级信息</a></td>";
                    item += "</tr>";
            });
            if (data == "" || data == null) {
                $("#tab").html("暂无该条数据");
                $("#Fy").css("display", "none");
            } else {
                $("#tab").html(item);
                //控制上一页和下一页的样式
                if (pagenumber == 1) {
                    $(".first").css("background-color", "#ced0d1");
                    $(".prv ").css("background-color", "#ced0d1");
                }
                else {
                    $(".first").css("background-color", "#fbfbfb");
                    $(".prv ").css("background-color", "#fbfbfb");
                }
                if (pagenumber == MAXpagenumber) {
                    $(".last").css("background-color", "#ced0d1");
                    $(".next").css("background-color", "#ced0d1");
                } else {
                    $(".last").css("background-color", "#fbfbfb");
                    $(".next").css("background-color", "#fbfbfb");
                }
                if (MAXpagenumber <= 1) {
                    $("#Fy").css("display", "none");
                } else {
                    $("#Fy").css("display", "block");
                }
            }
        });
       
    }
    
    //联想词功能
    function Lenovo(Conditions) {
        var data = {
            Value: Conditions
        };
     Le=$.get("/Class/Lenovo", data, function (data) {
            data = JSON.parse(data);
            var item = "";
         item += "<ul class='Le_ul'>";
            $.each(data, function (index,value) {
                item += "<li>" + value.ClassName + "</li>"
            });
            item += "</ul>";
            $("#LenovoBox").html(item);
        });
    }
  
    //修改状态
    function update(index) {
        var s = ALLdata[index].State;
        if (s== 1) {
            s = 0;
        } else {
            s= 1;
        };
        var data = {
            id: ALLdata[index].Id,
            state:s
        }
        $.post("/Class/UpdateState", data, function (value) {
            if (value == "True") {
                Search(Conditions);
            }
            else {
                alert("失败")
            }

        })
    };
    //查询所有班级
    function FindAllClass() {
        $.get("/Class/FindALLClass", "", function (data) {
           // data = JSON.parse(data);//把json字符串转换为json对象
            ALLdata = data;
            var count = Object.keys(data).length;//得到班级个数
            var item = "";
            item += "<option value='0'>查询所有</option>";
            //遍历集合
            $.each(data, function (index, value) {
                item += "<option value=" + value.Id + ">" + value.ClassName + "</option>";
            });
            $("#class").html(item);
        });
    }
    //学生管理
    function AddStudent(index) {
        var id = ALLdata[index].Id;
        var ClassName = ALLdata[index].ClassName;
        $("#StudentManagementtitle").html(ClassName);
        FindAllClass();
        ClassId = id;
        FandStuByClassorName();
        SelectStu(id);//根据班级id查询出班级已有的学生

    }

    //修改班级信息
    function UpdateClassInfo(index) {
        var Classid = ALLdata[index].Id;
        var ClassName = ALLdata[index].ClassName;
        ClassId = Classid;
        oldName = ClassName;
        $("#ClassName").val(ClassName);
    };
    //修改班级信息提交按钮
    $("#UpdateClassInfoOK").click(function () {
        var name = $("#ClassName").val();
        if (name == oldName) {
            $("#UpdateClassInfo").modal('hide');
        }
        if (name == "") {
            $("#UpdateClassInfoalert").html("*班级编号不能为空")
            $("#ClassName").focus();
        }  else {
            var data = {
                ClassId: ClassId,
                Number: name
            }
            $.post("/Class/AddSelect", data, function (value) {
                if (value == "True") {
                    $("#UpdateClassInfoalert").html("*该班级已存在")
                }
                else if (value == "False") {
                    $.post("/Class/UpdateClassInfo", data, function (value) {
                        if (value == "True") {
                            $("#UpdateClassInfo").modal('hide');
                           Search(Conditions);
                        }
                        else {
                            alert("修改失败");
                        }
                    })
                }
            })
        }

    })
    $(document).ready(function () {
        
        Search(Conditions);//查询所有班级
        //请求执行完后再执行分页
        $.when(pd).done(function () {
            page();
        });
        //分页大法
        function page() {
            $("#page").Page({
                totalPages: MAXpagenumber,//分页总数
                liNums: 5,//分页的数字按钮数(建议取奇数)
                activeClass: 'activP', //active 类样式定义
                callBack: function (page) {
                    pagenumber = page;
                    Search(Conditions);
                }
            });
        };
        FandStuByClassorName();//查询所有学生
        //移至该班按钮，批量操作学生
        $("#Movebtn").click(function () {
            //jquery获取复选框值
            var chk_value = [];//定义一个数组
            $('input[name="IntoStu"]:checked').each(function () {//遍历每一个名字为interest的复选框，其中选中的执行函数
                chk_value.push($(this).val());//将选中的值添加到数组chk_value中
            });
            var data = {
                list: chk_value,
                Classid: ClassId
            }
            $.post("/Class/IntoStu", data, function (data) {
                if (data == "True")
                {
                    alert("移动成功")
                } else {
                    alert("移动失败")
                }
                FandStuByClassorName();
                SelectStu(ClassId);
                FandStuByClassorName();
               Search(Conditions);
            });
        })
        ////点击添加学生模态框的退出按钮刷新页面数据
        $("#AddstuEsc").click(function () {
            //清空条件
            $("#class").val(0);
            $("#Stu_Name").val("");

        })
        //批量移除
        $("#outbtn").click(function () {
            var chk_value = [];//定义一个数组
            $('input[name="OutStu"]:checked').each(function () {//遍历每一个名字为interest的复选框，其中选中的执行函数
                chk_value.push($(this).val());//将选中的值添加到数组chk_value中
            });
            var data = {
                list: chk_value,
                ClassId: ClassId
            }
            $.post("/Class/OutStu", data, function (data) {
                if (data == "True") {

                    alert("移动成功")
                } else {
                    alert("移动失败")
                }
                FandStuByClassorName();
                SelectStu(ClassId);
               Search(Conditions);
            });
        })


        //班级下拉列表改变时获取班级下拉列表值
        $("#class").change(function () {
            $("#stu_alert").html("");
            FandStuByClassorName();
        })

        //点击按钮是切换页
        $(".pagination .number").click(function () {
            pagenumber =this.innerText;
           Search(Conditions);
        })
        //当输入框失去焦点是把内容传入后台进行查找判断该名称是否可用
        $("#AddClassName").focus(function () {
            $("#AddClassName").blur(function () {
                var ClassName = {
                    Name: $("#AddClassName").val(),
                }
                $.post("/Class/AddSelect", ClassName, function (value) {
                    if (value == "True") {
                        $("#alert").html("*该班级已存在")
                    }
                    else if (value == "False") {
                        $("#alert").html("")
                    }
                    State = value;  //给状态赋值
                })

            })
        })
        //添加班级
        $("#OK").click(function () {
            if (State == "True") {
                $("#AddClassName").focus()//该班级名称已被注册。
            } else if (State == "False") {
                $("#AddClass").modal('hide'); //关闭模态框
                $("#alert").html("");//不提示信息
                var Class = {
                    ClassName: $("#AddClassName").val(),
                }
                $.post("/Class/Add", Class, function (value) {
                    if (value == "True") {
                        $("#AddClassName").val("");
                        window.location.reload();
                       Search(Conditions);
                    }
                    else {
                        alert("添加错误,请联系管理员")
                    }
                })
            }
        });
        //上一页
        $("#last").click(function () {
            if (pagenumber > 1) {
                pagenumber--;
               Search(Conditions);
            }
        });
        //下一页
        $("#next").click(function () {
            if (pagenumber < MAXpagenumber) {
                pagenumber++;
               Search(Conditions);
            }

        });

    })
</script>
